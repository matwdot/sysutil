#!/bin/bash
#
# sysutil.sh - Script de utilitários para o SysPDV PDV em Linux
#
# Versão: 7.0
# Autor: Matheus Wesley
# GitHub: https://matheuswesley.github.io/devlinks
# GitHub Projeto: https://matwdot.github.io
# Licença: MIT
#
# *************************************************************

# ---------------------
# Importações
# ---------------------
. ./colors.sh
. ./functions.sh

# ---------------------
# Verificar se fzf está instalado
# ---------------------
HAS_FZF=false
command -v fzf &> /dev/null && HAS_FZF=true

# ---------------------
# Menu de SysPDV PDV
# ---------------------
menu_syspdv() {
  local options=(
    "Instalar SysPDV PDV"
    "Atualizar SysPDV PDV"
    "Voltar"
  )
  
  local functions=(
    "instalar_syspdv"
    "atualizar_syspdv"
  )
  
  submenu "SysPDV PDV" "${options[@]}" -- "${functions[@]}"
}

# ---------------------
# Menu de VPN
# ---------------------
menu_vpn() {
  local options=(
    "Instalar VPN"
    "Remover VPN"
    "Voltar"
  )
  
  local functions=(
    "instalar_vpn"
    "remover_vpn"
  )
  
  submenu "VPN Comnect" "${options[@]}" -- "${functions[@]}"
}

# ---------------------
# Menu de MFe
# ---------------------
menu_mfe() {
  local options=(
    "Instalar Driver MFe"
    "Remover Driver MFe"
    "Configurar DocGate"
    "Voltar"
  )
  
  local functions=(
    "baixar_drive_mfe"
    "remover_drive_mfe"
    "configurar_docgate"
  )
  
  submenu "MFe/DocGate" "${options[@]}" -- "${functions[@]}"
}

# ---------------------
# Menu principal
# ---------------------
main() {
  local options=(
    "SysPDV PDV"
    "VPN Comnect"
    "MFe/DocGate"
    "Configurar Periféricos"
    "Configurar Biométrico"
    "Limitar Consumo Tec55"
    "Transferência de Arquivos via SCP"
    "Manutenção via banco"
    "Sair"
  )
  
  local functions=(
    "menu_syspdv"
    "menu_vpn"
    "menu_mfe"
    "configurar_perifericos"
    "configurar_biometria"
    "limitar_consumo"
    "transferencia"
    "db_access"
    "exit_script"
  )
  
  local exit_index=$((${#options[@]} - 1))
  
  while true; do
    select_menu "SysUtil v7.0 beta" "${options[@]}"
    local result=$?
    
    # Se ESC no fzf ou escolheu Sair
    if [[ $result -eq 255 || $result -eq $exit_index ]]; then
      clear
      exit 0
    fi
    
    # Verifica se o índice é válido
    if [[ $result -ge 0 && $result -lt ${#functions[@]} ]]; then
      local func="${functions[$result]}"
      
      # Funções de submenu não precisam de clear/pause
      if [[ "$func" == menu_* ]]; then
        $func
      else
        clear
        $func
        read -p "Pressione Enter para continuar..."
      fi
    else
      echo -e "${RED}Opção inválida!${NC}"
      sleep 1
    fi
  done
}

# ---------------------
# Executa o menu principal
# ---------------------
main